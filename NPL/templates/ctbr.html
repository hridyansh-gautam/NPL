<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>ctbr Form</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
        <link rel="stylesheet" href="{{ url_for('static', filename='ctbr.css') }}" />
    </head>
    <body>
        <div class="wrapper">
            <header>
                <img src="{{ url_for('static', filename='images/logo1.png') }}" alt="National Physical Laboratory Logo" class="logo" />
                <div>
                    <h1 class="page-title">CSIR - National Physical Laboratory</h1>
                    <h3 class="page-subtitle">
                        सी एस आई आर - राष्ट्रीय भौतिक प्रयोगशाला
                    </h3>
                </div>
                <img class="company-name" src="{{ url_for('static', filename='images/logo2.png') }}" alt="CSIR - NPL" />
            </header>

            <nav>
                <a href="index.html">Home</a>
            </nav>

            <h1>CTBR Form</h1>

            <div class="content">
                <main class="container my-5">
                    <div class="progress mb-4">
                        <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;"></div>
                        <div class="step-label" style="left: 0%;">Step 1</div>
                        <div class="step-label" style="left: 20%;">Step 2</div>
                        <div class="step-label" style="left: 40%;">Step 3</div>
                        <div class="step-label" style="left: 60%;">Step 4</div>
                        <div class="step-label" style="left: 80%;">Step 5</div>
                    </div>

                    <form id="multiStepForm">
                        <div class="step active">
                            <h3>Organisation Details</h3>
                            <div class="row mb-3">
                                <div class="col required">
                                    <label for="orgName" class="form-label">Organisation Name</label>
                                    <input type="text" class="form-control" id="orgName" placeholder="Organisation Name" value="{{ customer['cust_name'] if customer else '' }}" required />
                                </div>
                            </div>
                            <div class="mb-3 required">
                                <label for="addressLine1" class="form-label">Organisation Address</label>
                                <input type="text" class="form-control" id="addressLine1" placeholder="Organisation Address" value="{{ customer['cust_addr_1'] if customer else '' }}" required />
                            </div>

                            <div class="row mb-3">
                                <div class="col required">
                                    <label for="country" class="form-label">Country</label>
                                    <select class="form-select" id="country" name="country" required>
                                        <option value="{{ customer['country'] if customer else '' }}" selected>{{ customer['country'] if customer else 'Select Country' }}</option>
                                    </select>
                                </div>
                                <div class="col required">
                                    <label for="state" class="form-label">State</label>
                                    <select class="form-select" id="state" name="state" required>
                                        <option value="{{ customer['state'] if customer else '' }}" selected>{{ customer['state'] if customer else 'Select State' }}</option>
                                    </select>
                                </div>
                                <div class="col required">
                                    <label for="city" class="form-label">City</label>
                                    <select class="form-select" id="city" name="city" required>
                                        <option value="{{ customer['city'] if customer else '' }}" selected>{{ customer['city'] if customer else 'Select City' }}</option>
                                    </select>
                                </div>
                                <div class="col required">
                                    <label for="pincode" class="form-label">Pincode</label>
                                    <input type="text" class="form-control" id="pincode" name="pincode" placeholder="Pincode" value="{{ customer['pincode'] if customer else '' }}" required />
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="contactPerson" class="form-label">Contact Person</label>
                                <input type="text" class="form-control" id="contactPerson" required />
                            </div>
                            <p>
                                Name & address of the organisation/firm in favour of which the Calibration certificate/ Test Report is to be issued (required if it is different from the above; else checkbox "same as above address" )
                            </p>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="sameAsAbove" />
                                <label class="form-check-label" for="sameAsAbove">Same as above address</label>
                            </div>

                            <div id="differentAddressInputs" class="hidden">
                                <div class="row mb-3">
                                    <div class="col required">
                                        <label for="diffOrgName" class="form-label">Organisation Name</label>
                                        <input type="text" class="form-control" id="diffOrgName" placeholder="Organisation Name" required />
                                    </div>
                                </div>
                                <div class="mb-3 required">
                                    <label for="diffAddressLine1" class="form-label">Organisation Address</label>
                                    <input type="text" class="form-control" id="diffAddressLine1" placeholder="Organisation Address" required />
                                </div>

                                <div class="row mb-3">
                                    <div class="col required">
                                        <label for="diffCity" class="form-label">City</label>
                                        <input type="text" class="form-control" id="diffCity" placeholder="City" required />
                                    </div>
                                    <div class="col required">
                                        <label for="diffState" class="form-label">State</label>
                                        <select class="form-select" id="diffState" required>
                                            <option selected disabled>Select State</option>
                                            <option value="state1">State 1</option>
                                            <option value="state2">State 2</option>
                                        </select>
                                    </div>
                                    <div class="col required">
                                        <label for="diffCountry" class="form-label">Country</label>
                                        <select class="form-select" id="diffCountry" required>
                                            <option selected disabled>Select Country</option>
                                            <option value="country1">Country 1</option>
                                            <option value="country2">Country 2</option>
                                        </select>
                                    </div>
                                    <div class="col required">
                                        <label for="diffPincode" class="form-label">Pincode</label>
                                        <input type="text" class="form-control" id="diffPincode" placeholder="Pincode" required />
                                    </div>
                                </div>
                            </div>

                            <div class="text-center">
                                <button type="button" class="btn btn-primary next">Next</button>
                            </div>
                        </div>

                        <div class="step">
                            <h3>Services</h3>
                            <div class="container mt-5">
                                <!-- Category Dropdown -->
                                <div class="form-group">
                                    <label for="categorySelect">Category</label>
                                    <select class="form-control" id="categorySelect" name="categorySelect" onchange="onSelectChange('categorySelect')">
                                        <option value="">Select Category</option>
                                        {% for classification in classifications %}
                                        <option value="{{ classification.service_code }}">{{ classification.service_name }}</option>
                                        {% endfor %}
                                    </select>                                    
                                </div>
                                <!-- Parameters Dropdown -->
                                <div class="form-group">
                                    <label for="parametersSelect">Parameters</label>
                                    <select class="form-control" id="parametersSelect" name="parametersSelect" onchange="onSelectChange('parametersSelect')">
                                        <option value=""></option>
                                    </select>
                                </div>
                                <!-- Item Type / Group Dropdown -->
                                <div class="form-group">
                                    <label for="itemTypeSelect">Item Type / Group</label>
                                    <select class="form-control" id="itemTypeSelect" name="itemTypeSelect" onchange="onSelectChange('itemTypeSelect')">
                                        <option value=""></option>
                                    </select>
                                </div>
                                <!-- Item Name Dropdown -->
                                <div class="form-group">
                                    <label for="itemNameSelect">Item Name</label>
                                    <select class="form-control" id="itemNameSelect" name="itemNameSelect" onchange="onSelectChange('itemNameSelect')">
                                        <option value=""></option>
                                    </select>
                                </div>
                                <!-- Alias Name Dropdown -->
                                <div class="form-group">
                                    <label for="aliasNameSelect">Alias Name</label>
                                    <select class="form-control" id="aliasNameSelect" name="aliasNameSelect" onchange="onSelectChange('aliasNameSelect')">
                                        <option value=""></option>
                                    </select>
                                </div>
                                <!-- Range Dropdown -->
                                <div class="form-group">
                                    <label for="rangeSelect">Range</label>
                                    <select class="form-control" id="rangeSelect" name="rangeSelect" onchange="onSelectChange('rangeSelect')">
                                        <option value=""></option>
                                    </select>
                                </div>
                                <!-- Calibration Parameters Dropdown -->
                                <div class="form-group">
                                    <label for="calibrationParametersSelect">Calibration Parameters</label>
                                    <select class="form-control" id="calibrationParametersSelect" name="calibrationParametersSelect" onchange="onSelectChange('calibrationParametersSelect')">
                                        <option value=""></option>
                                    </select>
                                </div>
                                <!-- No. of Points for Calibration / Procedure No. Dropdown -->
                                <div class="form-group">
                                    <label for="pointsSelect">No. of Points for Calibration / Procedure No.</label>
                                    <select class="form-control" id="pointsSelect" name="pointsSelect" onchange="onSelectChange('pointsSelect')">
                                        <option value=""></option>
                                    </select>
                                </div>
                                <!-- Limitation / Condition Dropdown -->
                                <div class="form-group">
                                    <label for="limitationSelect">Limitation / Condition</label>
                                    <select class="form-control" id="limitationSelect" name="limitationSelect" onchange="onSelectChange('limitationSelect')">
                                            <option value=""></option>
                                    </select>
                                </div>
                                <!-- Charges per Item Rs. Dropdown -->
                                <div class="form-group">
                                    <label for="chargesSelect">Charges per Item Rs.</label>
                                    <select class="form-control" id="chargesSelect" name="chargesSelect" onchange="onSelectChange('chargesSelect')">
                                        <option value=""></option>
                                    </select>
                                </div>
                                <!-- Additional Charges Rs. Dropdown -->
                                <div class="form-group">
                                    <label for="additionalChargesSelect">Additional Charges Rs.</label>
                                    <select class="form-control" id="additionalChargesSelect" name="additionalChargesSelect" onchange="onSelectChange('additionalChargesSelect')">
                                        <option value=""></option>
                                    </select>
                                </div>
                                <!-- Description for Additional Charges Dropdown -->
                                <div class="form-group">
                                    <label for="descriptionSelect">Description for Additional Charges</label>
                                    <select class="form-control" id="descriptionSelect" name="descriptionSelect" onchange="onSelectChange('descriptionSelect')">
                                        <option value=""></option>
                                    </select>
                                </div>
                                <!-- Remarks Dropdown -->
                                <div class="form-group">
                                    <label for="remarksSelect">Remarks, if any</label>
                                    <select class="form-control" id="remarksSelect" name="remarksSelect" onchange="onSelectChange('remarksSelect')">
                                        <option value=""></option>
                                    </select>
                                </div>
                                <div class="text-center">
                                    <button type="button" class="btn btn-secondary prev">
                                        Previous
                                    </button>
                                    <button type="button" class="btn btn-primary next">Next</button>
                                </div>
                            </div>
                        </div>

                        <div class="step">
                            <h3>Instrument(s)/Sample(s)/Reference Material/BND:</h3>
                            <div class="table-responsive mb-3">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>SR. No.</th>
                                            <th>Name of Instrument/Sample/Reference Material (BND)</th>
                                            <th>Make/Model/Sr. No./Batch/Lot No. or any other identification</th>
                                            <th>Quantity</th>
                                            <th>Total Charge</th>
                                            <th>Calibration/Testing Requirements/Specifications</th>
                                            <th>Remarks (If Any)</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tableBody">
                                        <tr>
                                            <td>1</td>
                                            <td><input type="text" class="form-control" /></td>
                                            <td><input type="text" class="form-control" /></td>
                                            <td><input type="number" class="form-control quantity" oninput="calculateRowTotal(this)" required/></td>
                                            <td><input type="number" class="form-control totalCharge" readonly /></td>
                                            <td><input type="text" class="form-control" /></td>
                                            <td><input type="text" class="form-control" /></td>
                                            <td>
                                                <button type="button" class="btn btn-danger btn-sm deleteRow">
                                                    Delete
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="text-center mb-3">
                                <button type="button" class="btn btn-secondary" id="addRow" onclick="redirectRow()">
                                    Add Row
                                </button>
                            </div>
                            <div class="text-center">
                                <button type="button" class="btn btn-secondary prev">
                                    Previous
                                </button>
                                <button type="button" class="btn btn-primary next">Next</button>
                            </div>
                        </div>

                        <div class="step">
                            <h3>Service Type</h3>
                            <div class="mb-3">
                                <label class="form-label">Calibration / Testing to be done under:</label>
                                <div>
                                    <input type="radio" id="input5Option1" name="input5" value="Option 1" required />
                                    <label for="input5Option1" class="me-3">Normal Service</label>
                                    <span class="mx-3">or</span>
                                    <input type="radio" id="input5Option2" name="input5" value="Option 2" required />
                                    <label for="input5Option2" class="ms-3">Express Service</label>
                                    <span class="mx-3">(Please choose any one)</span>
                                </div>
                            </div>

                            <h3>Details about Demand Draft/NEFT/RTGS</h3>
                            <div class="row mb-3">
                                <div class="col">
                                    <label for="bankName" class="form-label">Name of the bank:</label>
                                    <input type="text" class="form-control" id="bankName" required />
                                </div>
                                <div class="col">
                                    <label for="branch" class="form-label">Branch:</label>
                                    <input type="text" class="form-control" id="branch" required />
                                </div>
                                <div class="col">
                                    <label for="draftNumber" class="form-label">Draft/NEFT/RTGS No. :</label>
                                    <input type="number" class="form-control" id="draftNumber" required />
                                </div>
                                <div class="col">
                                    <label for="draftDate" class="form-label">Date:</label>
                                    <input type="date" class="form-control" id="draftDate" required />
                                </div>
                                <div class="col">
                                    <label for="amount" class="form-label">Amount (In Rs.):</label>
                                    <input type="number" class="form-control" id="amount" required />
                                </div>
                            </div>

                            <h3>Collection Type</h3>
                            <div class="mb-3">
                                <label class="form-label">Mode of collection / report / BND:</label>
                                <div>
                                    <input type="radio" id="collectionByHand" name="collectionType" value="By Hand" required />
                                    <label for="collectionByHand" class="me-3">By Hand</label>
                                    <span class="mx-3">or</span>
                                    <input type="radio" id="collectionByPost" name="collectionType" value="By Post" required />
                                    <label for="collectionByPost" class="ms-3">By Post</label>
                                    <span class="mx-3">(Please choose any one)</span>
                                </div>
                            </div>

                            <div class="text-center">
                                <button type="button" class="btn btn-secondary prev">
                                    Previous
                                </button>
                                <button type="button" class="btn btn-primary next">Next</button>
                            </div>
                        </div>

                        <div class="step">
                            <h3>Depositor Information</h3>
                            <div class="mb-3">
                                <label for="depositorName" class="form-label">Name of Depositor</label>
                                <input type="text" class="form-control" id="depositorName" required />
                            </div>

                            <div class="mb-3">
                                <label for="signature" class="form-label">Upload Signature</label>
                                <input type="file" class="form-control" id="signature" accept=".jpg, .jpeg, .png, .pdf" required />
                            </div>

                            <div class="text-center">
                                <button type="button" class="btn btn-secondary prev">
                                    Previous
                                </button>
                                <button type="submit" class="btn btn-success">Submit</button>
                            </div>
                        </div>
                    </form>
                </main>
            </div>

            <footer class="footer bg-light text-dark text-center py-3">
                <a href="{{ url_for('logout')}}">Logout</a>
            </footer>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="{{ url_for('static', filename='ctbr.js') }}"></script>
        <script>
            const apiConfig = {
                baseUrl: "https://api.countrystatecity.in/v1",
                apiKey: "NHhvOEcyWk50N2Vna3VFTE00bFp3MjFKR0ZEOUhkZlg4RTk1MlJlaA==",
            };

            const countryDropdown = document.getElementById("country");
            const stateDropdown = document.getElementById("state");
            const cityDropdown = document.getElementById("city");

            function populateDropdown(dropdown, items, defaultText) {
                dropdown.innerHTML = `<option value="">${defaultText}</option>`;
                items.forEach((item) => {
                    const option = document.createElement("option");
                    option.value = item.iso2 || item.id;
                    option.textContent = item.name;
                    dropdown.appendChild(option);
                });
            }

            function loadCountries() {
                fetch(`${apiConfig.baseUrl}/countries`, {
                    headers: { "X-CSCAPI-KEY": apiConfig.apiKey },
                })
                    .then((response) => response.json())
                    .then((data) => {
                        populateDropdown(countryDropdown, data, "Select Country");
                    })
                    .catch((error) => console.error("Error loading countries:", error));
            }

            function loadStates(countryCode) {
                fetch(`${apiConfig.baseUrl}/countries/${countryCode}/states`, {
                    headers: { "X-CSCAPI-KEY": apiConfig.apiKey },
                })
                    .then((response) => response.json())
                    .then((data) => {
                        populateDropdown(stateDropdown, data, "Select State");
                        cityDropdown.innerHTML = '<option value="">Select City</option>';
                    })
                    .catch((error) => console.error("Error loading states:", error));
            }

            function loadCities(countryCode, stateCode) {
                fetch(`${apiConfig.baseUrl}/countries/${countryCode}/states/${stateCode}/cities`, {
                    headers: { "X-CSCAPI-KEY": apiConfig.apiKey },
                })
                    .then((response) => response.json())
                    .then((data) => {
                        populateDropdown(cityDropdown, data, "Select City");
                    })
                    .catch((error) => console.error("Error loading cities:", error));
            }

            countryDropdown.addEventListener("change", () => {
                const countryCode = countryDropdown.value;
                if (countryCode) {
                    loadStates(countryCode);
                } else {
                    stateDropdown.innerHTML = '<option value="">Select State</option>';
                    cityDropdown.innerHTML = '<option value="">Select City</option>';
                }
            });

            stateDropdown.addEventListener("change", () => {
                const countryCode = countryDropdown.value;
                const stateCode = stateDropdown.value;
                if (countryCode && stateCode) {
                    loadCities(countryCode, stateCode);
                } else {
                    cityDropdown.innerHTML = '<option value="">Select City</option>';
                }
            });

            // window.onload = loadCountries; Change later if need to edit
        </script>
        <script>
            function onSelectChange(dropdownId) {
            console.log("Dropdown ID: ", dropdownId);
            var element = document.getElementById(dropdownId);
            if (!element) {
                console.error("Element not found: ", dropdownId);
                return;
            }
            var value = element.value;
            console.log("Selected value: ", value);
            fetchDataAndPopulate(dropdownId, value);
            }
        
            function fetchDataAndPopulate(field, value) {
                var body = {};
                body[field] = value;
                fetch('/ctbr', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(body).toString()
                })
                .then(response => response.json())
                .then(data => {
                    var services = data.services;
                    var charges = data.charges;
                    switch (field) {
                        case 'categorySelect':
                            populateDropdown('parametersSelect', services, 'parameter');
                            clearDropdown('itemTypeSelect');
                            clearDropdown('itemNameSelect');
                            clearDropdown('aliasNameSelect');
                            clearDropdown('rangeSelect');
                            clearDropdown('calibrationParametersSelect');
                            clearDropdown('pointsSelect');
                            clearDropdown('limitationSelect');
                            clearDropdown('chargesSelect');
                            clearDropdown('additionalChargesSelect');
                            clearDropdown('descriptionSelect');
                            clearDropdown('remarksSelect');
                            break;
                        case 'parametersSelect':
                            populateDropdown('itemTypeSelect', services, 'item_type_group');
                            clearDropdown('itemNameSelect');
                            clearDropdown('aliasNameSelect');
                            clearDropdown('rangeSelect');
                            clearDropdown('calibrationParametersSelect');
                            clearDropdown('pointsSelect');
                            clearDropdown('limitationSelect');
                            clearDropdown('chargesSelect');
                            clearDropdown('additionalChargesSelect');
                            clearDropdown('descriptionSelect');
                            clearDropdown('remarksSelect');
                            break;
                        case 'itemTypeSelect':
                            populateDropdown('itemNameSelect', services, 'item_name');
                            clearDropdown('aliasNameSelect');
                            clearDropdown('rangeSelect');
                            clearDropdown('calibrationParametersSelect');
                            clearDropdown('pointsSelect');
                            clearDropdown('limitationSelect');
                            clearDropdown('chargesSelect');
                            clearDropdown('additionalChargesSelect');
                            clearDropdown('descriptionSelect');
                            clearDropdown('remarksSelect');
                            break;
                        case 'itemNameSelect':
                            populateDropdown('aliasNameSelect', services, 'alias_name');
                            clearDropdown('rangeSelect');
                            clearDropdown('calibrationParametersSelect');
                            clearDropdown('pointsSelect');
                            clearDropdown('limitationSelect');
                            clearDropdown('chargesSelect');
                            clearDropdown('additionalChargesSelect');
                            clearDropdown('descriptionSelect');
                            clearDropdown('remarksSelect');
                            break;
                        case 'aliasNameSelect':
                            populateDropdown('rangeSelect', services, 'range');
                            clearDropdown('calibrationParametersSelect');
                            clearDropdown('pointsSelect');
                            clearDropdown('limitationSelect');
                            clearDropdown('chargesSelect');
                            clearDropdown('additionalChargesSelect');
                            clearDropdown('descriptionSelect');
                            clearDropdown('remarksSelect');
                            break;
                        case 'rangeSelect':
                            populateDropdown('calibrationParametersSelect', services, 'calibration_parameters');
                            clearDropdown('pointsSelect');
                            clearDropdown('limitationSelect');
                            clearDropdown('chargesSelect');
                            clearDropdown('additionalChargesSelect');
                            clearDropdown('descriptionSelect');
                            clearDropdown('remarksSelect');
                            break;
                        case 'calibrationParametersSelect':
                            populateDropdown('pointsSelect', services, 'no_of_points_for_calibration_procedure_no');
                            clearDropdown('limitationSelect');
                            clearDropdown('chargesSelect');
                            clearDropdown('additionalChargesSelect');
                            clearDropdown('descriptionSelect');
                            clearDropdown('remarksSelect');
                            break;
                        case 'pointsSelect':
                            populateDropdown('limitationSelect', services, 'limitation_condition');
                            clearDropdown('chargesSelect');
                            clearDropdown('additionalChargesSelect');
                            clearDropdown('descriptionSelect');
                            clearDropdown('remarksSelect');
                            break;
                        case 'limitationSelect':
                            populateDropdown('chargesSelect', charges, 'charges_per_item_rs');
                            clearDropdown('additionalChargesSelect');
                            clearDropdown('descriptionSelect');
                            clearDropdown('remarksSelect');
                            break;
                        case 'chargesSelect':
                            populateDropdown('additionalChargesSelect', charges, 'additional_charges_rs');
                            clearDropdown('descriptionSelect');
                            clearDropdown('remarksSelect');
                            break;
                        case 'additionalChargesSelect':
                            populateDropdown('descriptionSelect', charges, 'description_for_additional_charges');
                            clearDropdown('remarksSelect');
                            break;
                        case 'descriptionSelect':
                            populateDropdown('remarksSelect', charges, 'remarks_if_any');
                            break;
                        default:
                            break;
                    }
                });
            }
        
            function populateDropdown(dropdownId, data, key) {
                var dropdown = document.getElementById(dropdownId);
                var labelText = getLabelText(dropdownId);
                dropdown.innerHTML = '<option value="">Select ' + labelText + '</option>';
                var uniqueItems = [...new Set(data.map(item => item[key]))];
                uniqueItems.forEach(value => {
                    var option = document.createElement('option');
                    option.value = value;
                    option.text = value;
                    dropdown.appendChild(option);
                });
            }
        
            function clearDropdown(dropdownId) {
                var dropdown = document.getElementById(dropdownId);
                var labelText = getLabelText(dropdownId);
                dropdown.innerHTML = '<option value="">Select ' + labelText + '</option>';
            }
        
            function getLabelText(dropdownId) {
                var label = document.querySelector('label[for="' + dropdownId + '"]');
                return label ? label.textContent : dropdownId;
            }
        </script>
        <script>
            function calculateRowTotal(input) {
            var row = input.closest('tr');
            var quantity = parseInt(row.querySelector('.quantity').value) || 0;
            var chargesPerItem = parseFloat(document.getElementById('chargesSelect').value) || 0;
            var additionalCharges = parseFloat(document.getElementById('additionalChargesSelect').value) || 0;
            var totalCharge = (chargesPerItem + additionalCharges) * quantity;
            row.querySelector('.totalCharge').value = totalCharge;
            }
        </script>                  
        <script>
            function redirectRow(){
                steps[3].classList.remove("active");
                steps[2].classList.add("active");
            }
        </script>            
    </body>
</html>